<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="rakuda_waist_test">

  <!-- 1) Link base e link waist -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <link name="waist_link">
    <inertial>
      <origin xyz="0 0 0.1" rpy="0 0 0"/>
      <mass value="1.0"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <!-- 2) Joint waist: revolute attorno a z -->
  <joint name="waist_joint" type="revolute">
    <parent link="base_link"/>
    <child link="waist_link"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <axis xyz="0 0 1"/>
    <!-- limiti fittizi, adatta ai gradi reali -->
    <limit lower="-1.57" upper="1.57" effort="2.0" velocity="1.0"/>
    <dynamics damping="0.0" friction="0.0"/>
  </joint>

  <!-- 3) Blocco ros2_control -->
<ros2_control name="DynamixelWaistSystem" type="system">
  <hardware>
    <plugin>dynamixel_hardware_interface/DynamixelHardware</plugin>

    <!-- Porta seriale del tuo U2D2 -->
    <param name="port_name">/dev/ttyUSB0</param> <!-- o il tuo /dev/dxl_u2d2, ecc. -->
    <param name="baud_rate">3000000</param>

    <!-- Timeout (facoltativo, ma utile) -->
    <param name="error_timeout_ms">1000</param>

    <!-- *** QUI LA PARTE CHE MANCA *** -->
    <!-- Path ai file .model del pacchetto dynamixel_hardware_interface -->
    <param name="dynamixel_model_folder">/param/dxl_model</param>

    <!-- 1 giunto, 1 trasmissione -->
    <param name="number_of_joints">1</param>
    <param name="number_of_transmissions">1</param>

    <!-- Disattiva il torque all’avvio (Robotis consiglia così) -->
    <param name="disable_torque_at_init">true</param>

    <!-- Per un solo giunto, le matrici sono l'identità 1x1 -->
    <param name="transmission_to_joint_matrix">
      1
    </param>
    <param name="joint_to_transmission_matrix">
      1
    </param>

    <!-- Parametri opzionali, ma allineati agli esempi Robotis -->
    <param name="dynamixel_state_pub_msg_name">dynamixel_hardware_interface/dxl_state</param>
    <param name="get_dynamixel_data_srv_name">dynamixel_hardware_interface/get_dxl_data</param>
    <param name="set_dynamixel_data_srv_name">dynamixel_hardware_interface/set_dxl_data</param>
    <param name="reboot_dxl_srv_name">dynamixel_hardware_interface/reboot_dxl</param>
    <param name="set_dxl_torque_srv_name">dynamixel_hardware_interface/set_dxl_torque</param>
  </hardware>

  <!-- Il tuo joint waist_joint -->
  <joint name="waist_joint">
    <command_interface name="position"/>
    <state_interface name="position"/>
    <state_interface name="velocity"/>
    <state_interface name="effort"/>
  </joint>

  <!-- Il tuo Dynamixel reale -->
  <gpio name="waist_motor">
    <param name="type">dxl</param>
    <param name="ID">1</param> <!-- ID del Dynamixel sul bus -->

    <!-- Comando e stati come da documentazione -->
    <command_interface name="Goal Position"/>
    <state_interface name="Present Position"/>
    <state_interface name="Present Velocity"/>


    <!-- Qualche parametro base -->
    <param name="Operating Mode">3</param> <!-- Position mode -->
    <param name="Profile Velocity">0</param>
    <param name="Profile Acceleration">0</param>
    <param name="Position P Gain">800</param>
    <param name="Position I Gain">0</param>
    <param name="Position D Gain">0</param>
  </gpio>
</ros2_control>



</robot>
